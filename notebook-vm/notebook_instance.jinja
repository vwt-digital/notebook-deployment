resources:
- name: {{ env["project"] }}-vn
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: true

- name: {{ env["project"] }}-fw
  type: compute.v1.firewall
  properties:
    network: $(ref.{{ env["project"] }}-vn.selfLink)
    allowed:
    - IPProtocol: TCP
      ports:
      - 22

- name: {{ env["project"] }}-vm
  type: compute.v1.instance
  properties:
    zone: {{ properties["zone"] }}
    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/machineTypes/{{ properties["machineType"] }}
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/deeplearning-platform-release/global/images/family/{{ properties["imageFamily"] }}
    networkInterfaces:
    - network: $(ref.{{ env["project"] }}-vn.selfLink)
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
    metadata:
     items:
       - key: startup-script
         value: |
           #! /bin/bash
           apt-get install sysstat bc

           {% include "ashutdown" %} >> /usr/local/bin/ashutdown
           {% include "ashutdown.service" %} >> /lib/systemd/system/ashutdown.service
           systemctl --no-reload --now enable /lib/systemd/system/ashutdown.service

       - key: tags
         value: deeplearning-vm
       {% if properties["mail"] %}
       - key: proxy-user-mail
         value: {{ properties["mail"] }}
       {% endif %}
       - key: proxy-mode
         value: {{ properties["proxy-mode"] }}
       - key: install-nvidia-driver
         value: "True"
    {% if properties["gpu-type"] %}
    guestAccelerators:
      - acceleratorType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/acceleratorTypes/{{ properties["gpu-type"] }}
        acceleratorCount: {{ properties["gpu-count"] }}
    scheduling:
      onHostMaintenance: "TERMINATE"
    {% endif %}
    serviceAccounts:
    {% if properties["service-account"] %}
      - email: {{ properties["service-account"] }}
        scopes:
        - https://www.googleapis.com/auth/cloud-platform
        - https://www.googleapis.com/auth/userinfo.email
    {% else %}
      - email: {{ env["project_number"] }}-compute@developer.gserviceaccount.com
        scopes:
        - https://www.googleapis.com/auth/cloud-platform
        - https://www.googleapis.com/auth/userinfo.email
    {% endif %}
